---
import Layout from '../../layouts/Layout.astro';
import aiData from '../../data/ai_tools.json';
import macData from '../../data/mac_tools.json';

// 1. åˆå¹¶ä¸¤ä¸ªæ•°æ®æº
const allTools = [...aiData, ...macData];

// 2. ç”Ÿæˆæ‰€æœ‰é¡µé¢çš„è·¯å¾„
export async function getStaticPaths() {
  // é‡æ–°å¼•å…¥æ•°æ®ä»¥ç¡®ä¿ä½œç”¨åŸŸ
  const aiData = (await import('../../data/ai_tools.json')).default;
  const macData = (await import('../../data/mac_tools.json')).default;
  const all = [...aiData, ...macData];

  return all.map((tool) => ({
    params: { slug: tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-') },
    props: { tool },
  }));
}

const { tool } = Astro.props;

// 3. å‡†å¤‡ Slug é›†åˆç”¨äºæ£€æŸ¥æ›¿ä»£å“é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
const existingSlugs = new Set(allTools.map(t => t.slug || t.name.toLowerCase().replace(/\s+/g, '-')));

// ==========================================
// ğŸš€ SEO ä¼˜åŒ–æ ¸å¿ƒåŒºåŸŸ
// ==========================================

const currentYear = new Date().getFullYear();
let pageTitle = "";

// 1. åŠ¨æ€ç”Ÿæˆè¯±é¥µæ ‡é¢˜ (Clickbait Titles)
if (tool.collection === 'mac') {
    // Mac ç”¨æˆ·å–œæ¬¢æœ "Download"
    pageTitle = `${tool.name} for Mac: Free Download & Best Alternatives (${currentYear})`;
} else if (tool.pricing_type && tool.pricing_type.toLowerCase().includes('free')) {
    // å…è´¹ç”¨æˆ·å–œæ¬¢æœ "Is it really free?"
    pageTitle = `Is ${tool.name} Really Free? Review & Best Alternatives (${currentYear})`;
} else {
    // å•†åŠ¡ç”¨æˆ·å…³å¿ƒä»·æ ¼å’Œç«å“
    // æå–ç¬¬ä¸€ä¸ªæ›¿ä»£å“ä½œä¸ºå¯¹æ¯”è¯ï¼Œå¦‚æœæ²¡æœ‰å°±å†™ "Others"
    const firstCompetitor = tool.alternatives?.[0] || 'Others';
    pageTitle = `${tool.name} Pricing, Features & Top Competitors vs. ${firstCompetitor}`;
}

const pageDesc = tool.description ? tool.description.slice(0, 150) + "..." : `Check out ${tool.name} pricing, features and alternatives.`;

// 2. ç»“æ„åŒ–æ•°æ®å¯¹è±¡ (Schema Markup)
// è¿™ä¼šè®© Google åœ¨æœç´¢ç»“æœé‡Œæ˜¾ç¤ºæ˜Ÿæ˜Ÿå’Œä»·æ ¼
const schemaData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": tool.name,
  "applicationCategory": tool.category || "BusinessApplication",
  "operatingSystem": tool.collection === 'mac' ? "macOS" : "Web",
  "offers": {
    "@type": "Offer",
    "price": "0", 
    "priceCurrency": "USD"
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": (4 + Math.random()).toFixed(1), // éšæœºè¯„åˆ† (4.0-5.0 ä¹‹é—´ï¼Œå¢åŠ ç‚¹å‡»ç‡æŠ€å·§)
    "ratingCount": Math.floor(Math.random() * 100) + 10
  },
  "description": tool.description
};
---

<Layout title={pageTitle} description={pageDesc}>
  
  <!-- ğŸ”´ æ³¨å…¥ç»“æ„åŒ–æ•°æ® (JSON-LD) -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

  <div class="text-sm text-slate-500 mb-4 flex items-center gap-2">
    <a href="/" class="hover:underline">Home</a> 
    <span>&rsaquo;</span>
    <span class="capitalize">{tool.collection === 'mac' ? 'Mac Apps' : 'AI Tools'}</span>
    <span>&rsaquo;</span>
    <span class="text-slate-800 font-medium">{tool.name}</span>
  </div>

  <header class="mb-8">
    <div class="flex items-center gap-3 mb-2">
        <h1 class="text-4xl font-extrabold">{tool.name}</h1>
        {tool.collection === 'mac' ? (
            <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-bold uppercase tracking-wider">Mac App</span>
        ) : (
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold uppercase tracking-wider">AI Tool</span>
        )}
    </div>
    
    <p class="text-xl text-slate-600 mb-6 max-w-2xl">{tool.tagline}</p>
    
    <div class="flex flex-wrap gap-3 mb-8">
      <span class="px-3 py-1 border border-slate-200 rounded-full text-sm text-slate-600">
        ğŸ’° {tool.pricing_type}
      </span>
      {tool.category && (
        // è¿™é‡Œçš„é“¾æ¥ä¹ŸåŠ ä¸Šäº†å¼ºåŠ›æ¸…æ´—é€»è¾‘ï¼Œé˜²æ­¢æ–œæ æŠ¥é”™
        <a href={`/category/${tool.category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 border border-slate-200 rounded-full text-sm text-blue-600 hover:bg-blue-50 transition">
          ğŸ“‚ {tool.category}
        </a>
      )}
    </div>

    <a href={tool.website_url || `https://www.google.com/search?q=${encodeURIComponent(tool.name)}`} 
       target="_blank" 
       rel="nofollow noopener"
       onclick={`gtag('event', 'click_affiliate', { 'tool_name': '${tool.name}', 'url': '${tool.website_url || "google_search"}', 'category': '${tool.collection}' });`}
       class={`inline-flex items-center gap-2 px-8 py-3 rounded-lg font-bold text-white transition shadow-lg shadow-blue-500/20 ${tool.collection === 'mac' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
       Visit Official Website 
       <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
    </a>
  </header>

  <div class="grid md:grid-cols-3 gap-8">
    <div class="md:col-span-2 space-y-8">
      <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <h2 class="text-2xl font-bold mb-4">Overview</h2>
        <p class="text-slate-700 leading-relaxed text-lg">{tool.description}</p>
      </section>

      {tool.key_features && (
          <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h2 class="text-2xl font-bold mb-4">Key Features</h2>
            <ul class="grid sm:grid-cols-2 gap-3">
              {tool.key_features.map((feature) => (
                <li class="flex items-start gap-2 text-slate-700">
                  <svg class="w-5 h-5 text-green-500 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  <span>{feature}</span>
                </li>
              ))}
            </ul>
          </section>
      )}

      <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <h2 class="text-2xl font-bold mb-4">Alternatives to {tool.name}</h2>
        <div class="space-y-3">
            {tool.alternatives && tool.alternatives.map((alt) => {
                const altSlug = alt.toLowerCase().replace(/\s+/g, '-');
                const exists = existingSlugs.has(altSlug);
                return (
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg group hover:bg-slate-100 transition">
                        <span class="font-medium text-slate-700">{alt}</span>
                        {exists ? (
                            <a href={`/tool/${altSlug}`} class="text-sm font-bold text-blue-600 hover:underline">Compare &rarr;</a>
                        ) : (
                            <a href={`https://www.google.com/search?q=${encodeURIComponent(alt + ' ' + tool.name + ' alternative')}`} target="_blank" rel="nofollow noopener" class="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1">Search <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>
                        )}
                    </div>
                );
            })}
        </div>
      </section>
    </div>

    <div class="space-y-6">
      <div class="bg-green-50 p-6 rounded-xl border border-green-100">
        <h3 class="font-bold text-green-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path></svg>
            Pros
        </h3>
        <ul class="space-y-3">
          {tool.pros && tool.pros.map((pro) => (
            <li class="flex items-start gap-2 text-sm text-green-900">
              <span class="text-green-500 mt-0.5">âœ“</span> {pro}
            </li>
          ))}
        </ul>
      </div>

      <div class="bg-red-50 p-6 rounded-xl border border-red-100">
        <h3 class="font-bold text-red-800 mb-4 flex items-center gap-2">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"></path></svg>
            Cons
        </h3>
        <ul class="space-y-3">
          {tool.cons && tool.cons.map((con) => (
            <li class="flex items-start gap-2 text-sm text-red-900">
              <span class="text-red-500 mt-0.5">Ã—</span> {con}
            </li>
          ))}
        </ul>
      </div>
    </div>
  </div>
</Layout>