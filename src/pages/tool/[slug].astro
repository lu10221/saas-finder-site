---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// ËæÖÂä©ÂáΩÊï∞ÔºöÂÆâÂÖ®ËØªÂèñ
const getJson = (filename) => {
  try {
      let filePath = path.join(process.cwd(), 'public', 'data', filename);
      if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
      
      if (fs.existsSync(filePath)) {
          return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
      }
      return [];
  } catch (e) { return []; }
};

export async function getStaticPaths() {
  const getJson = (filename) => {
    try {
        let filePath = path.join(process.cwd(), 'public', 'data', filename);
        if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
        
        if (fs.existsSync(filePath)) {
            return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
        }
        return [];
    } catch (e) { return []; }
  };

  const aiData = getJson('ai_tools.json');
  const macData = getJson('mac_tools.json');
  const selfData = getJson('selfhosted_tools.json'); // üî¥ Êñ∞Â¢û
  
  const aiTools = aiData.map(t => ({ ...t, collection: 'ai' }));
  const macTools = macData.map(t => ({ ...t, collection: 'mac' }));
  const selfTools = selfData.map(t => ({ ...t, collection: 'selfhosted' })); // üî¥ Êñ∞Â¢û
  
  const all = [...aiTools, ...macTools, ...selfTools];

  return all.map((tool) => ({
    params: { slug: tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') },
    props: { tool, allTools: all },
  }));
}

const { tool, allTools } = Astro.props;
const existingSlugs = new Set(allTools.map(t => t.slug || t.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')));

// ==========================================
// üöÄ SEO ÈÖçÁΩÆ
// ==========================================

const currentYear = new Date().getFullYear();
let pageTitle = "";

if (tool.collection === 'mac') {
    pageTitle = `${tool.name} for Mac: Free Download & Best Alternatives (${currentYear})`;
} else if (tool.collection === 'selfhosted') {
    // üî¥ Self-Hosted ‰∏ìÂ±ûÊ†áÈ¢ò
    pageTitle = `${tool.name} Self-Hosted Alternative: Deploy, Features & Comparison (${currentYear})`;
} else if (tool.pricing_type && tool.pricing_type.toLowerCase().includes('free')) {
    pageTitle = `Is ${tool.name} Really Free? Review & Best Alternatives (${currentYear})`;
} else {
    const firstCompetitor = tool.alternatives?.[0] || 'Others';
    pageTitle = `${tool.name} Pricing, Features & Top Competitors vs. ${firstCompetitor}`;
}

const pageDesc = tool.description ? tool.description.slice(0, 150) + "..." : `Check out ${tool.name} pricing, features and alternatives.`;

// È¢úËâ≤‰∏ªÈ¢òÈÄªËæë
let themeColor = 'blue'; // ai default
if (tool.collection === 'mac') themeColor = 'purple';
if (tool.collection === 'selfhosted') themeColor = 'orange';

// Schema
const softwareSchema = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": tool.name,
  "applicationCategory": tool.category || "BusinessApplication",
  "operatingSystem": tool.collection === 'mac' ? "macOS" : "Web",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "aggregateRating": { "@type": "AggregateRating", "ratingValue": (4 + Math.random()).toFixed(1), "ratingCount": Math.floor(Math.random() * 100) + 10 },
  "description": tool.description
};

const faqSchema = tool.faqs && tool.faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": tool.faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": { "@type": "Answer", "text": faq.answer }
  }))
} : null;

const relatedTools = allTools
    .filter(t => t.category === tool.category && t.name !== tool.name)
    .sort(() => 0.5 - Math.random())
    .slice(0, 3);
---

<Layout title={pageTitle} description={pageDesc} type="article">
  <script type="application/ld+json" set:html={JSON.stringify(softwareSchema)} />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

  <nav class="text-sm text-slate-500 mb-6 flex items-center flex-wrap gap-2">
    <a href="/" class="hover:underline hover:text-blue-600">Home</a> 
    <span>/</span>
    <span class="capitalize">{tool.collection === 'ai' ? 'AI Tools' : (tool.collection === 'mac' ? 'Mac Apps' : 'Self-Hosted')}</span>
    {tool.category && (
        <>
            <span>/</span>
            <a href={`/category/${tool.category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="hover:underline hover:text-blue-600">{tool.category}</a>
        </>
    )}
    <span>/</span>
    <span class="text-slate-800 font-medium truncate max-w-[200px]">{tool.name}</span>
  </nav>

  <header class="mb-10 bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center md:text-left">
    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
        <div>
            <div class="flex items-center justify-center md:justify-start gap-3 mb-3">
                <h1 class="text-4xl font-extrabold text-slate-900">{tool.name}</h1>
                <span class={`px-2.5 py-0.5 bg-${themeColor}-100 text-${themeColor}-700 rounded-full text-xs font-bold uppercase tracking-wider`}>
                    {tool.collection === 'ai' ? 'AI' : (tool.collection === 'mac' ? 'Mac' : 'Self-Hosted')}
                </span>
            </div>
            <p class="text-xl text-slate-600 max-w-2xl leading-relaxed">{tool.tagline}</p>
        </div>
        
        <a href={tool.website_url || `https://www.google.com/search?q=${encodeURIComponent(tool.name)}`} 
           target="_blank" 
           rel="nofollow noopener"
           onclick={`gtag('event', 'click_affiliate', { 'tool_name': '${tool.name}', 'url': '${tool.website_url || "google_search"}', 'category': '${tool.collection}' });`}
           class={`inline-flex items-center justify-center gap-2 px-8 py-3 rounded-lg font-bold text-white transition shadow-lg shadow-blue-500/20 transform hover:-translate-y-0.5 active:translate-y-0 ${tool.collection === 'mac' ? 'bg-purple-600 hover:bg-purple-700' : (tool.collection === 'selfhosted' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700')}`}>
           Visit Website 
           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        </a>
    </div>
  </header>

  <div class="grid md:grid-cols-3 gap-8">
    <div class="md:col-span-2 space-y-12">
      <section>
        <h2 class="text-2xl font-bold mb-4 text-slate-800 border-b pb-2">Overview</h2>
        <div class="prose prose-slate max-w-none text-slate-700 leading-7">
            <p>{tool.description}</p>
        </div>
      </section>

      {tool.key_features && (
          <section>
            <h2 class="text-2xl font-bold mb-4 text-slate-800 border-b pb-2">Key Features</h2>
            <ul class="grid sm:grid-cols-2 gap-x-4 gap-y-3">
              {tool.key_features.map((feature) => (
                <li class="flex items-start gap-2.5 text-slate-700">
                  <svg class="w-5 h-5 text-green-500 mt-1 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  <span>{feature}</span>
                </li>
              ))}
            </ul>
          </section>
      )}

      {tool.faqs && tool.faqs.length > 0 && (
          <section>
            <h2 class="text-2xl font-bold mb-6 text-slate-800 border-b pb-2">Frequently Asked Questions</h2>
            <div class="space-y-4">
                {tool.faqs.map((faq) => (
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 transition hover:shadow-sm">
                        <h3 class="text-lg font-bold text-slate-900 mb-2 flex items-start gap-3">
                            <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs shrink-0 mt-0.5 font-bold">?</span>
                            {faq.question}
                        </h3>
                        <p class="text-slate-600 leading-relaxed ml-9">{faq.answer}</p>
                    </div>
                ))}
            </div>
          </section>
      )}

      <section>
        <h2 class="text-2xl font-bold mb-4 text-slate-800 border-b pb-2">Top Alternatives</h2>
        <div class="grid gap-3">
            {tool.alternatives && tool.alternatives.map((alt) => {
                const altSlug = alt.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                const exists = existingSlugs.has(altSlug);
                return (
                    <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:border-blue-200 transition">
                        <span class="font-semibold text-slate-800">{alt}</span>
                        {exists ? (
                            <a href={`/tool/${altSlug}`} class="text-sm font-bold text-blue-600 hover:underline flex items-center gap-1">
                                Compare <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </a>
                        ) : (
                            <a href={`https://www.google.com/search?q=${encodeURIComponent(alt + ' ' + tool.name + ' alternative')}`} target="_blank" rel="nofollow noopener" class="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1">
                                Search Google <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        )}
                    </div>
                );
            })}
        </div>
      </section>
    </div>

    <div class="space-y-8">
      <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 sticky top-24">
        <h3 class="font-bold text-slate-900 mb-4">Tool Info</h3>
        <div class="space-y-4 text-sm">
            <div class="flex justify-between border-b border-slate-200 pb-2">
                <span class="text-slate-500">Pricing</span>
                <span class="font-medium text-slate-900">{tool.pricing_type}</span>
            </div>
            {tool.category && (
                <div class="flex justify-between border-b border-slate-200 pb-2">
                    <span class="text-slate-500">Category</span>
                    <a href={`/category/${tool.category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="font-medium text-blue-600 hover:underline">{tool.category}</a>
                </div>
            )}
            <div class="flex justify-between border-b border-slate-200 pb-2">
                <span class="text-slate-500">Collection</span>
                <span class="font-medium text-slate-900 capitalize">{tool.collection === 'ai' ? 'AI' : (tool.collection === 'mac' ? 'Mac' : 'Self-Hosted')}</span>
            </div>
        </div>

        <div class="mt-8 space-y-4">
            {tool.pros && tool.pros.length > 0 && (
                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                    <h4 class="font-bold text-green-800 mb-2 flex items-center gap-2 text-xs uppercase tracking-wide">Pros</h4>
                    <ul class="space-y-2 text-sm text-green-900">
                        {tool.pros.map(pro => <li class="flex gap-2"><span class="font-bold">‚äï</span> {pro}</li>)}
                    </ul>
                </div>
            )}
            {tool.cons && tool.cons.length > 0 && (
                <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                    <h4 class="font-bold text-red-800 mb-2 flex items-center gap-2 text-xs uppercase tracking-wide">Cons</h4>
                    <ul class="space-y-2 text-sm text-red-900">
                        {tool.cons.map(con => <li class="flex gap-2"><span class="font-bold">‚äñ</span> {con}</li>)}
                    </ul>
                </div>
            )}
        </div>
      </div>
    </div>
  </div>

  {relatedTools.length > 0 && (
      <section class="mt-16 pt-10 border-t border-slate-200">
        <h2 class="text-2xl font-bold mb-6">More {tool.category} Tools</h2>
        <div class="grid md:grid-cols-3 gap-6">
            {relatedTools.map(t => (
                <a href={`/tool/${t.slug || t.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="block p-5 rounded-xl border border-slate-200 hover:border-blue-300 hover:shadow-md transition bg-white group">
                    <h3 class="font-bold text-slate-900 mb-1 group-hover:text-blue-600">{t.name}</h3>
                    <p class="text-xs text-slate-500 line-clamp-2">{t.tagline}</p>
                </a>
            ))}
        </div>
      </section>
  )}
</Layout>