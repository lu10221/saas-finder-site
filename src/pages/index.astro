---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// ==========================================
// 1. æœåŠ¡ç«¯æ•°æ®é¢„å– (SSR)
// ==========================================
function getInitialData(filename) {
  try {
    let filePath = path.join(process.cwd(), 'public', 'data', filename);
    if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);

    if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf-8');
        const data = JSON.parse(content);
        
        let type = 'ai';
        if (filename.includes('mac')) type = 'mac';
        if (filename.includes('selfhosted')) type = 'selfhosted';
        if (filename.includes('windows')) type = 'windows';
        if (filename.includes('publicapis')) type = 'publicapis'; // ğŸ”´ æ–°å¢
        
        // âœ‚ï¸ é¦–å±åˆ‡ç‰‡
        return data.slice(0, 36).map(t => ({ ...t, collection: type }));
    }
    return [];
  } catch (e) { return []; }
}

function getCategories(filename) {
    try {
        let filePath = path.join(process.cwd(), 'public', 'data', filename);
        if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
        if (fs.existsSync(filePath)) {
            const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
            return [...new Set(data.map(t => t.category).filter(Boolean))].sort();
        }
        return [];
    } catch (e) { return []; }
}

// è¯»å–æ•°æ®
const initialAi = getInitialData('ai_tools.json');
const initialMac = getInitialData('mac_tools.json');
const initialWin = getInitialData('windows_tools.json');
const initialApi = getInitialData('publicapis_tools.json'); // ğŸ”´
const initialSelf = getInitialData('selfhosted_tools.json');

// è¯»å–åˆ†ç±»
const aiCats = getCategories('ai_tools.json');
const macCats = getCategories('mac_tools.json');
const winCats = getCategories('windows_tools.json');
const apiCats = getCategories('publicapis_tools.json'); // ğŸ”´
const selfCats = getCategories('selfhosted_tools.json');
---

<Layout title="ToolStock - Best Software & API Directory" description="Discover AI tools, Mac apps, Windows software, Public APIs, and Self-Hosted alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-600 to-green-500">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated directory of best software & developer resources.
    </p>

    <div class="flex flex-wrap justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-xl w-fit mx-auto">
      <button class="tab-btn active px-4 py-2 rounded-lg font-bold text-sm transition bg-white text-blue-600 shadow-sm" data-target="ai">ğŸ¤– AI</button>
      <button class="tab-btn px-4 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="mac">ğŸ Mac</button>
      <button class="tab-btn px-4 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="windows">ğŸªŸ Win</button>
      <button class="tab-btn px-4 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="publicapis">âš¡ APIs</button> <button class="tab-btn px-4 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="selfhosted">ğŸ³ Self-Hosted</button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search tools & APIs..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      <div id="search-loading" class="hidden absolute right-4 top-1/2 -translate-y-1/2">
        <svg class="animate-spin h-5 w-5 text-blue-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      </div>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {aiCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>)}
    </div>
    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {macCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>)}
    </div>
    <div id="cat-windows" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {winCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-sky-600 hover:border-sky-300 transition">{cat}</a>)}
    </div>
    <div id="cat-publicapis" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {apiCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-green-600 hover:border-green-300 transition">{cat}</a>)}
    </div>
    <div id="cat-selfhosted" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {selfCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-orange-600 hover:border-orange-300 transition">{cat}</a>)}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialAi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialMac.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-windows" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialWin.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-sky-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-sky-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-sky-50 text-sky-600 rounded">Windows</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-publicapis" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialApi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-green-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-green-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-green-50 text-green-600 rounded">API</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-selfhosted" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialSelf.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-orange-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-orange-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-orange-50 text-orange-600 rounded">Self-Hosted</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">Load More Tools</button>
  </div>
  <div id="no-results" class="hidden text-center py-12"><p class="text-lg text-slate-500">No tools found matching your search.</p></div>

  <script is:inline>
    // æ•°æ®æ¡¶
    let lightData = []; // AI, Mac, Win, APIs
    let heavyData = []; // Self-Hosted (å·¨å¤§)
    
    let isLightLoaded = false;
    let isHeavyLoaded = false;
    let isLoadingHeavy = false;
    let currentTab = 'ai';
    let debounceTimer;

    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const searchLoading = document.getElementById('search-loading');
    const noResults = document.getElementById('no-results');

    async function loadLightData() {
        if (isLightLoaded) return;
        loadMoreBtn.textContent = "Loading...";
        try {
            // ğŸ”´ å¢åŠ  publicapis_tools.json
            const [rAi, rMac, rWin, rApi] = await Promise.all([
                fetch('/data/ai_tools.json'),
                fetch('/data/mac_tools.json'),
                fetch('/data/windows_tools.json'),
                fetch('/data/publicapis_tools.json')
            ]);
            
            const dAi = await rAi.json();
            const dMac = await rMac.json();
            const dWin = await rWin.json();
            const dApi = await rApi.json();
            
            lightData = [
                ...dAi.map(t => ({...t, collection: 'ai'})),
                ...dMac.map(t => ({...t, collection: 'mac'})),
                ...dWin.map(t => ({...t, collection: 'windows'})),
                ...dApi.map(t => ({...t, collection: 'publicapis'})) // ğŸ”´
            ];
            
            isLightLoaded = true;
            if (currentTab !== 'selfhosted') loadMoreBtn.textContent = "Load More Tools";
        } catch (e) { console.error("Light load error", e); }
    }

    async function loadHeavyData() {
        if (isHeavyLoaded || isLoadingHeavy) return;
        isLoadingHeavy = true;
        if (currentTab === 'selfhosted') loadMoreBtn.textContent = "Loading full database...";
        if (searchInput.value.length > 0) searchLoading.classList.remove('hidden');

        try {
            const rSelf = await fetch('/data/selfhosted_tools.json');
            const dSelf = await rSelf.json();
            heavyData = dSelf.map(t => ({...t, collection: 'selfhosted'}));
            isHeavyLoaded = true;
            isLoadingHeavy = false;
            searchLoading.classList.add('hidden');
            loadMoreBtn.textContent = "Load More Tools";
            
            if (searchInput.value.trim().length > 0) performSearch(searchInput.value.trim());
        } catch (e) {
            console.error("Heavy load error", e);
            loadMoreBtn.textContent = "Load Failed";
            isLoadingHeavy = false;
            searchLoading.classList.add('hidden');
        }
    }

    // æ˜¾å¼é¢œè‰²é€»è¾‘
    function createCardHtml(tool) {
        let color = 'blue', hover = 'blue', badge = 'AI';
        
        if (tool.collection === 'mac') { color = 'purple'; hover = 'purple'; badge = 'Mac'; }
        if (tool.collection === 'selfhosted') { color = 'orange'; hover = 'orange'; badge = 'Self-Hosted'; }
        if (tool.collection === 'windows') { color = 'sky'; hover = 'sky'; badge = 'Windows'; }
        if (tool.collection === 'publicapis') { color = 'green'; hover = 'green'; badge = 'API'; } // ğŸ”´

        const slug = tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        
        return `<a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-${hover}-300 transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:text-${color}-600">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 bg-${color}-50 text-${color}-600 rounded">${badge}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span></div>
        </a>`;
    }

    searchInput.addEventListener('focus', () => { loadLightData(); loadHeavyData(); });
    loadMoreBtn.addEventListener('mouseenter', loadLightData);

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(t => t.className = 'tab-btn px-4 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700');
            const target = btn.dataset.target;
            let activeColor = 'text-blue-600';
            if (target === 'mac') activeColor = 'text-purple-600';
            if (target === 'selfhosted') activeColor = 'text-orange-600';
            if (target === 'windows') activeColor = 'text-sky-600';
            if (target === 'publicapis') activeColor = 'text-green-600'; // ğŸ”´
            
            btn.className = `tab-btn active px-4 py-2 rounded-lg font-bold text-sm transition bg-white ${activeColor} shadow-sm`;
            currentTab = target;
            
            document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
            document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`cat-${currentTab}`).classList.remove('hidden');
            
            if (currentTab === 'selfhosted' && !isHeavyLoaded) loadHeavyData();
            else if (!isLightLoaded) loadLightData();
            
            loadMoreBtn.classList.remove('hidden');
        });
    });

    loadMoreBtn.addEventListener('click', async () => {
        if (currentTab === 'selfhosted' && !isHeavyLoaded) { await loadHeavyData(); return; }
        if (currentTab !== 'selfhosted' && !isLightLoaded) { await loadLightData(); }
        
        let targetData = [];
        if (currentTab === 'selfhosted') targetData = heavyData;
        else targetData = lightData.filter(t => t.collection === currentTab);

        const targetGrid = document.getElementById(`grid-${currentTab}`);
        const currentCount = targetGrid.children.length;
        
        if (currentCount < targetData.length) {
            const remaining = targetData.slice(currentCount, currentCount + 24);
            targetGrid.insertAdjacentHTML('beforeend', remaining.map(createCardHtml).join(''));
        }
        
        if (targetGrid.children.length >= targetData.length) loadMoreBtn.classList.add('hidden');
    });

    function performSearch(term) {
        loadMoreBtn.classList.add('hidden');
        ['ai', 'mac', 'selfhosted', 'windows', 'publicapis'].forEach(t => document.getElementById(`grid-${t}`).classList.remove('hidden')); // ğŸ”´

        const renderGroup = (data, id) => {
            const matches = data.filter(t => t.name.toLowerCase().includes(term));
            const el = document.getElementById(id);
            el.innerHTML = matches.slice(0, 12).map(createCardHtml).join('');
            return matches.length;
        };

        const cAi = renderGroup(lightData.filter(t => t.collection === 'ai'), 'grid-ai');
        const cMac = renderGroup(lightData.filter(t => t.collection === 'mac'), 'grid-mac');
        const cWin = renderGroup(lightData.filter(t => t.collection === 'windows'), 'grid-windows');
        const cApi = renderGroup(lightData.filter(t => t.collection === 'publicapis'), 'grid-publicapis'); // ğŸ”´
        
        let cSelf = 0;
        if (isHeavyLoaded) cSelf = renderGroup(heavyData, 'grid-selfhosted');
        else document.getElementById('grid-selfhosted').innerHTML = '<div class="col-span-full text-center text-sm text-gray-400 py-4">Searching Self-Hosted...</div>';

        if (cAi + cMac + cWin + cApi + cSelf === 0 && isHeavyLoaded) noResults.classList.remove('hidden');
        else noResults.classList.add('hidden');
    }

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        clearTimeout(debounceTimer);
        if (term.length === 0) { window.location.reload(); return; }
        debounceTimer = setTimeout(() => {
            if (!isLightLoaded) loadLightData();
            if (!isHeavyLoaded) loadHeavyData();
            performSearch(term);
        }, 300);
    });
  </script>
</Layout>