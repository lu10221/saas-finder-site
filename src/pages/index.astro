---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// ==========================================
// 1. æœåŠ¡ç«¯æ•°æ®é¢„å– (åªå–å‰36ä¸ªç”¨äºé¦–å±æ¸²æŸ“)
// ==========================================
function getInitialData(filename) {
  try {
    let filePath = path.join(process.cwd(), 'public', 'data', filename);
    if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);

    if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf-8');
        const data = JSON.parse(content);
        
        let type = 'ai';
        if (filename.includes('mac')) type = 'mac';
        if (filename.includes('selfhosted')) type = 'selfhosted';
        if (filename.includes('windows')) type = 'windows';
        
        // âœ‚ï¸ åªåˆ‡ç‰‡å‰ 36 ä¸ªï¼Œä¿è¯ HTML ä½“ç§¯æå°
        return data.slice(0, 36).map(t => ({ ...t, collection: type }));
    }
    return [];
  } catch (e) { return []; }
}

function getCategories(filename) {
    try {
        let filePath = path.join(process.cwd(), 'public', 'data', filename);
        if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
        if (fs.existsSync(filePath)) {
            const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
            return [...new Set(data.map(t => t.category).filter(Boolean))].sort();
        }
        return [];
    } catch (e) { return []; }
}

// è¯»å–æ‰€æœ‰æ•°æ®çš„"é¦–å±åˆ‡ç‰‡"
const initialAi = getInitialData('ai_tools.json');
const initialMac = getInitialData('mac_tools.json');
const initialWin = getInitialData('windows_tools.json');
const initialSelf = getInitialData('selfhosted_tools.json');

// è¯»å–åˆ†ç±»
const aiCats = getCategories('ai_tools.json');
const macCats = getCategories('mac_tools.json');
const winCats = getCategories('windows_tools.json');
const selfCats = getCategories('selfhosted_tools.json');
---

<Layout title="ToolStock - Best Software Directory (AI, Mac, Windows & Self-Hosted)" description="Discover the best AI tools, Mac apps, Windows software, and Self-Hosted alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-600 to-orange-500">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated directory of best software alternatives.
    </p>

    <div class="flex flex-wrap justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-xl w-fit mx-auto">
      <button class="tab-btn active px-5 py-2 rounded-lg font-bold text-sm transition bg-white text-blue-600 shadow-sm" data-target="ai">ğŸ¤– AI Tools</button>
      <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="mac">ğŸ Mac Apps</button>
      <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="windows">ğŸªŸ Windows</button>
      <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="selfhosted">ğŸ³ Self-Hosted</button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search tools..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      <div id="search-loading" class="hidden absolute right-4 top-1/2 -translate-y-1/2">
        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      </div>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {aiCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>)}
    </div>
    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {macCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>)}
    </div>
    <div id="cat-windows" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {winCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-sky-600 hover:border-sky-300 transition">{cat}</a>)}
    </div>
    <div id="cat-selfhosted" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {selfCats.map((cat) => <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-orange-600 hover:border-orange-300 transition">{cat}</a>)}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialAi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialMac.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-windows" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialWin.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-sky-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-sky-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-sky-50 text-sky-600 rounded">Windows</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-selfhosted" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialSelf.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-orange-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-orange-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-orange-50 text-orange-600 rounded">Self-Hosted</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">Load More Tools</button>
  </div>
  <div id="no-results" class="hidden text-center py-12"><p class="text-lg text-slate-500">No tools found matching your search.</p></div>

  <script is:inline>
    // æ•°æ®æ¡¶
    let lightData = []; // AI, Mac, Win
    let heavyData = []; // Self-Hosted (å·¨å¤§)
    
    // çŠ¶æ€ä½
    let isLightLoaded = false;
    let isHeavyLoaded = false;
    let isLoadingHeavy = false;
    let currentTab = 'ai';
    let debounceTimer; // é˜²æŠ–

    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const searchLoading = document.getElementById('search-loading');
    const noResults = document.getElementById('no-results');

    // 1. åŠ è½½è½»é‡æ•°æ® (å¿«é€Ÿ)
    async function loadLightData() {
        if (isLightLoaded) return;
        loadMoreBtn.textContent = "Loading...";
        try {
            const [rAi, rMac, rWin] = await Promise.all([
                fetch('/data/ai_tools.json'),
                fetch('/data/mac_tools.json'),
                fetch('/data/windows_tools.json')
            ]);
            
            const dAi = await rAi.json();
            const dMac = await rMac.json();
            const dWin = await rWin.json();
            
            lightData = [
                ...dAi.map(t => ({...t, collection: 'ai'})),
                ...dMac.map(t => ({...t, collection: 'mac'})),
                ...dWin.map(t => ({...t, collection: 'windows'}))
            ];
            
            isLightLoaded = true;
            if (currentTab !== 'selfhosted') loadMoreBtn.textContent = "Load More Tools";
        } catch (e) {
            console.error("Light load error", e);
        }
    }

    // 2. åŠ è½½é‡é‡çº§æ•°æ® (åªåœ¨éœ€è¦æ—¶åŠ è½½)
    async function loadHeavyData() {
        if (isHeavyLoaded || isLoadingHeavy) return;
        isLoadingHeavy = true;
        
        // åªæœ‰åœ¨ Self-Hosted æ ‡ç­¾ä¸‹æ‰æ˜¾ç¤ºåŠ è½½æç¤º
        if (currentTab === 'selfhosted') loadMoreBtn.textContent = "Loading full database...";
        if (searchInput.value.length > 0) searchLoading.classList.remove('hidden');

        try {
            const rSelf = await fetch('/data/selfhosted_tools.json');
            const dSelf = await rSelf.json();
            
            heavyData = dSelf.map(t => ({...t, collection: 'selfhosted'}));
            
            isHeavyLoaded = true;
            isLoadingHeavy = false;
            searchLoading.classList.add('hidden');
            
            loadMoreBtn.textContent = "Load More Tools";
            
            // å¦‚æœåŠ è½½å®Œæˆæ—¶ç”¨æˆ·æ­£åœ¨æœç´¢ï¼Œåˆ·æ–°æœç´¢ç»“æœ
            if (searchInput.value.trim().length > 0) {
                performSearch(searchInput.value.trim());
            } else if (currentTab === 'selfhosted') {
                // å¦‚æœåˆšå¥½åœ¨ SelfHosted é¡µé¢ï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥å¯ç”¨"åŠ è½½æ›´å¤š"
                // (è¿™é‡Œç®€å•èµ·è§ï¼Œä¸é‡ç½® DOMï¼Œåªæ˜¯è§£é”æŒ‰é’®)
            }

        } catch (e) {
            console.error("Heavy load error", e);
            loadMoreBtn.textContent = "Load Failed";
            isLoadingHeavy = false;
            searchLoading.classList.add('hidden');
        }
    }

    // å¡ç‰‡ HTML ç”Ÿæˆå™¨
    function createCardHtml(tool) {
        let color = 'blue', hover = 'blue', badge = 'AI';
        
        if (tool.collection === 'mac') { color = 'purple'; hover = 'purple'; badge = 'Mac'; }
        if (tool.collection === 'selfhosted') { color = 'orange'; hover = 'orange'; badge = 'Self-Hosted'; }
        if (tool.collection === 'windows') { color = 'sky'; hover = 'sky'; badge = 'Windows'; }

        const slug = tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        
        return `<a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-${hover}-300 transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:text-${color}-600">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 bg-${color}-50 text-${color}-600 rounded">${badge}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2">
                <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span>
            </div>
        </a>`;
    }

    // äº¤äº’è§¦å‘åŠ è½½
    searchInput.addEventListener('focus', () => {
        loadLightData();
        loadHeavyData(); // æœç´¢æ—¶é¢„åŠ è½½å¤§æ–‡ä»¶
    });
    
    loadMoreBtn.addEventListener('mouseenter', loadLightData);

    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // UI Update
            document.querySelectorAll('.tab-btn').forEach(t => t.className = 'tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700');
            const target = btn.dataset.target;
            let activeColor = 'text-blue-600';
            if (target === 'mac') activeColor = 'text-purple-600';
            if (target === 'selfhosted') activeColor = 'text-orange-600';
            if (target === 'windows') activeColor = 'text-sky-600';
            
            btn.className = `tab-btn active px-5 py-2 rounded-lg font-bold text-sm transition bg-white ${activeColor} shadow-sm`;
            currentTab = target;
            
            // Toggle Views
            document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
            
            document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`cat-${currentTab}`).classList.remove('hidden');
            
            // Logic: Load heavy data if clicking Self-Hosted
            if (currentTab === 'selfhosted' && !isHeavyLoaded) {
                loadHeavyData();
            } else if (!isLightLoaded) {
                loadLightData();
            }
            
            loadMoreBtn.classList.remove('hidden');
        });
    });

    // åŠ è½½æ›´å¤šé€»è¾‘
    loadMoreBtn.addEventListener('click', async () => {
        // æ•°æ®æ£€æŸ¥
        if (currentTab === 'selfhosted' && !isHeavyLoaded) {
            await loadHeavyData(); // å¦‚æœè¿˜æ²¡åŠ è½½å®Œï¼Œç‚¹å‡»æŒ‰é’®å…ˆåŠ è½½æ•°æ®
            return;
        }
        if (currentTab !== 'selfhosted' && !isLightLoaded) {
            await loadLightData();
        }
        
        let targetData = [];
        if (currentTab === 'selfhosted') targetData = heavyData;
        else targetData = lightData.filter(t => t.collection === currentTab);

        const targetGrid = document.getElementById(`grid-${currentTab}`);
        const currentCount = targetGrid.children.length;
        
        if (currentCount < targetData.length) {
            // æ¯æ¬¡è¿½åŠ  24 ä¸ª
            const remaining = targetData.slice(currentCount, currentCount + 24);
            targetGrid.insertAdjacentHTML('beforeend', remaining.map(createCardHtml).join(''));
        }
        
        if (targetGrid.children.length >= targetData.length) {
            loadMoreBtn.classList.add('hidden');
        }
    });

    // æœç´¢é€»è¾‘ (å¸¦ 300ms é˜²æŠ–)
    function performSearch(term) {
        loadMoreBtn.classList.add('hidden');
        ['ai', 'mac', 'selfhosted', 'windows'].forEach(t => document.getElementById(`grid-${t}`).classList.remove('hidden'));

        // æ¸²æŸ“è¾…åŠ©å‡½æ•°
        const renderGroup = (data, id) => {
            const matches = data.filter(t => t.name.toLowerCase().includes(term));
            const el = document.getElementById(id);
            // æœç´¢ç»“æœé™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé˜²æ­¢æ¸²æŸ“å¤ªå¤šå¡æ­»
            el.innerHTML = matches.slice(0, 12).map(createCardHtml).join('');
            return matches.length;
        };

        const cAi = renderGroup(lightData.filter(t => t.collection === 'ai'), 'grid-ai');
        const cMac = renderGroup(lightData.filter(t => t.collection === 'mac'), 'grid-mac');
        const cWin = renderGroup(lightData.filter(t => t.collection === 'windows'), 'grid-windows');
        
        let cSelf = 0;
        if (isHeavyLoaded) {
            cSelf = renderGroup(heavyData, 'grid-selfhosted');
        } else {
            // å¦‚æœè¿˜åœ¨åŠ è½½ï¼Œæ˜¾ç¤ºæç¤º
            document.getElementById('grid-selfhosted').innerHTML = '<div class="col-span-full text-center text-sm text-gray-400 py-4">Searching Self-Hosted database...</div>';
        }

        if (cAi + cMac + cWin + cSelf === 0 && isHeavyLoaded) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        
        // æ¸…é™¤æ—§å®šæ—¶å™¨
        clearTimeout(debounceTimer);

        if (term.length === 0) {
            window.location.reload();
            return;
        }

        // è®¾ç½®æ–°å®šæ—¶å™¨ (300ms åæ‰§è¡Œ)
        debounceTimer = setTimeout(() => {
            if (!isLightLoaded) loadLightData();
            if (!isHeavyLoaded) loadHeavyData(); // å¿…é¡»è§¦å‘å¤§æ–‡ä»¶åŠ è½½
            
            performSearch(term);
        }, 300);
    });
  </script>
</Layout>