---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// è¯»å–å‰ 36 ä¸ªæ•°æ®ç”¨äºé¦–å±ç›´å‡º (æœåŠ¡ç«¯æ¸²æŸ“)
function getInitialData(filename) {
  try {
    const filePath = path.join(process.cwd(), 'public', 'data', filename);
    const content = fs.readFileSync(filePath, 'utf-8');
    const data = JSON.parse(content);
    const type = filename.includes('ai') ? 'ai' : 'mac';
    return data.slice(0, 36).map(t => ({ ...t, collection: type }));
  } catch (e) { return []; }
}

const initialAi = getInitialData('ai_tools.json');
const initialMac = getInitialData('mac_tools.json');

// è¯»å–åˆ†ç±» (æœåŠ¡ç«¯)
const fullAiContent = fs.readFileSync(path.join(process.cwd(), 'public', 'data', 'ai_tools.json'), 'utf-8');
const fullMacContent = fs.readFileSync(path.join(process.cwd(), 'public', 'data', 'mac_tools.json'), 'utf-8');
const aiCategories = [...new Set(JSON.parse(fullAiContent).map(t => t.category).filter(Boolean))].sort();
const macCategories = [...new Set(JSON.parse(fullMacContent).map(t => t.category).filter(Boolean))].sort();
---

<Layout title="ToolStock - Best AI & Mac Tools Directory" description="Discover the best AI tools and Mac software alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated directory of best software alternatives.
    </p>

    <div class="flex justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-full w-fit mx-auto">
      <button class="tab-btn active px-8 py-2.5 rounded-full font-bold text-sm transition-all duration-200 bg-white text-blue-600 shadow-sm ring-1 ring-slate-200" data-target="ai">ğŸ¤– AI Tools</button>
      <button class="tab-btn px-8 py-2.5 rounded-full font-bold text-sm transition-all duration-200 text-slate-500 hover:text-slate-700" data-target="mac">ğŸ Mac Apps</button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search specific tool..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {aiCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {macCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>
      ))}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialAi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
        </div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialMac.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
        </div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">Load More Tools</button>
  </div>
  <div id="no-results" class="hidden text-center py-12"><p class="text-lg text-slate-500">No tools found matching your search.</p></div>

  <script is:inline defer>
    // å˜é‡åˆå§‹åŒ–
    let allAiData = [];
    let allMacData = [];
    let isDataLoaded = false;
    let currentTab = 'ai';

    // ç¼“å­˜ DOM å…ƒç´ 
    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const gridAi = document.getElementById('grid-ai');
    const gridMac = document.getElementById('grid-mac');
    const noResults = document.getElementById('no-results');

    // å¼‚æ­¥ä¸‹è½½æ•°æ®
    async function loadAllData() {
        if (isDataLoaded) return;
        loadMoreBtn.textContent = "Loading...";
        try {
            const [resAi, resMac] = await Promise.all([
                fetch('/data/ai_tools.json'),
                fetch('/data/mac_tools.json')
            ]);
            const rawAi = await resAi.json();
            const rawMac = await resMac.json();
            
            allAiData = rawAi.map(t => ({...t, collection: 'ai'}));
            allMacData = rawMac.map(t => ({...t, collection: 'mac'}));
            
            isDataLoaded = true;
            loadMoreBtn.textContent = "Load More Tools";
        } catch (e) {
            loadMoreBtn.textContent = "Error";
        }
    }

    function createCardHtml(tool) {
        const isMac = tool.collection === 'mac';
        const colorClass = isMac ? 'text-purple-600' : 'text-blue-600';
        const hoverClass = isMac ? 'hover:border-purple-300' : 'hover:border-blue-300';
        const badgeBg = isMac ? 'bg-purple-50' : 'bg-blue-50';
        const slug = tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-');
        // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰å›¾ç‰‡ï¼Œå¦‚æœæœ‰å›¾ç‰‡è®°å¾—åŠ  loading="lazy"
        return `<a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md ${hoverClass} transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:${colorClass}">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 ${badgeBg} ${colorClass} rounded">${isMac ? 'Mac' : 'AI'}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2">
                <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span>
            </div>
        </a>`;
    }

    // äº‹ä»¶ç›‘å¬
    searchInput.addEventListener('focus', loadAllData);
    loadMoreBtn.addEventListener('mouseenter', loadAllData);

    loadMoreBtn.addEventListener('click', async () => {
        await loadAllData();
        const targetData = currentTab === 'ai' ? allAiData : allMacData;
        const targetGrid = currentTab === 'ai' ? gridAi : gridMac;
        const currentCount = targetGrid.children.length;
        if (currentCount < targetData.length) {
            const remaining = targetData.slice(currentCount);
            // ä½¿ç”¨ requestAnimationFrame é¿å…å¡é¡¿
            requestAnimationFrame(() => {
                targetGrid.insertAdjacentHTML('beforeend', remaining.map(createCardHtml).join(''));
            });
        }
        loadMoreBtn.classList.add('hidden');
    });

    searchInput.addEventListener('input', async (e) => {
        const term = e.target.value.toLowerCase();
        if (!isDataLoaded && term.length > 0) await loadAllData();

        if (term.length > 0) {
            loadMoreBtn.classList.add('hidden');
            gridAi.classList.remove('hidden');
            gridMac.classList.remove('hidden');

            const aiMatches = allAiData.filter(t => t.name.toLowerCase().includes(term));
            const macMatches = allMacData.filter(t => t.name.toLowerCase().includes(term));

            gridAi.innerHTML = aiMatches.map(createCardHtml).join('');
            gridMac.innerHTML = macMatches.map(createCardHtml).join('');

            if (aiMatches.length === 0 && macMatches.length === 0) noResults.classList.remove('hidden');
            else noResults.classList.add('hidden');
        } else {
            window.location.reload();
        }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(t => {
                t.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'ring-1', 'ring-slate-200');
                t.classList.add('text-slate-500');
            });
            btn.classList.remove('text-slate-500');
            btn.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'ring-1', 'ring-slate-200');

            currentTab = btn.dataset.target;
            document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
            document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`cat-${currentTab}`).classList.remove('hidden');
            
            // åˆ‡æ¢ Tab æ—¶é‡ç½®æŒ‰é’®çŠ¶æ€
            loadMoreBtn.classList.remove('hidden');
        });
    });
  </script>
</Layout>