---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è¯»å–æ•°æ®
function getInitialData(filename) {
  try {
    let filePath = path.join(process.cwd(), 'public', 'data', filename);
    if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);

    if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf-8');
        const data = JSON.parse(content);
        
        // æ˜¾å¼æ‰“æ ‡ï¼Œé˜²æ­¢é€»è¾‘é”™è¯¯
        let type = 'ai';
        if (filename.includes('mac')) type = 'mac';
        if (filename.includes('selfhosted')) type = 'selfhosted';
        if (filename.includes('windows')) type = 'windows'; // ğŸ”´
        
        return data.slice(0, 36).map(t => ({ ...t, collection: type }));
    }
    return [];
  } catch (e) { return []; }
}

function getCategories(filename) {
    try {
        let filePath = path.join(process.cwd(), 'public', 'data', filename);
        if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
        if (fs.existsSync(filePath)) {
            const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
            return [...new Set(data.map(t => t.category).filter(Boolean))].sort();
        }
        return [];
    } catch (e) { return []; }
}

// 1. è¯»å–æ‰€æœ‰æ•°æ®
const initialAi = getInitialData('ai_tools.json');
const initialMac = getInitialData('mac_tools.json');
const initialSelf = getInitialData('selfhosted_tools.json');
const initialWin = getInitialData('windows_tools.json'); // ğŸ”´

// 2. è¯»å–æ‰€æœ‰åˆ†ç±»
const aiCats = getCategories('ai_tools.json');
const macCats = getCategories('mac_tools.json');
const selfCats = getCategories('selfhosted_tools.json');
const winCats = getCategories('windows_tools.json'); // ğŸ”´
---

<Layout title="ToolStock - Best Software Directory (AI, Mac, Windows & Self-Hosted)" description="Discover the best AI tools, Mac apps, Windows software, and Self-Hosted alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-600 to-sky-500">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated directory of best software alternatives.
    </p>

    <div class="flex flex-wrap justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-xl w-fit mx-auto">
      <button class="tab-btn active px-5 py-2 rounded-lg font-bold text-sm transition bg-white text-blue-600 shadow-sm" data-target="ai">ğŸ¤– AI Tools</button>
      <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="mac">ğŸ Mac Apps</button>
      <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="windows">ğŸªŸ Windows</button> <button class="tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700" data-target="selfhosted">ğŸ³ Self-Hosted</button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search for tools..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {aiCats.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {macCats.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-windows" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {winCats.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-sky-600 hover:border-sky-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-selfhosted" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {selfCats.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-orange-600 hover:border-orange-300 transition">{cat}</a>
      ))}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialAi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialMac.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-windows" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialWin.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-sky-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-sky-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-sky-50 text-sky-600 rounded">Windows</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div id="grid-selfhosted" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialSelf.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-orange-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-orange-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-orange-50 text-orange-600 rounded">Self-Hosted</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span></div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">Load More Tools</button>
  </div>
  <div id="no-results" class="hidden text-center py-12"><p class="text-lg text-slate-500">No tools found matching your search.</p></div>

  <script is:inline>
    let allAiData = [], allMacData = [], allSelfData = [], allWinData = []; // ğŸ”´
    let isDataLoaded = false;
    let currentTab = 'ai';

    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const noResults = document.getElementById('no-results');

    async function loadAllData() {
        if (isDataLoaded) return;
        loadMoreBtn.textContent = "Loading...";
        try {
            // ğŸ”´ åŠ è½½æ‰€æœ‰4ä¸ªJSON
            const [rAi, rMac, rSelf, rWin] = await Promise.all([
                fetch('/data/ai_tools.json'),
                fetch('/data/mac_tools.json'),
                fetch('/data/selfhosted_tools.json'),
                fetch('/data/windows_tools.json')
            ]);
            
            const dAi = await rAi.json();
            const dMac = await rMac.json();
            const dSelf = await rSelf.json();
            const dWin = await rWin.json();
            
            allAiData = dAi.map(t => ({...t, collection: 'ai'}));
            allMacData = dMac.map(t => ({...t, collection: 'mac'}));
            allSelfData = dSelf.map(t => ({...t, collection: 'selfhosted'}));
            allWinData = dWin.map(t => ({...t, collection: 'windows'})); // ğŸ”´
            
            isDataLoaded = true;
            loadMoreBtn.textContent = "Load More Tools";
        } catch (e) {
            loadMoreBtn.textContent = "Error Loading";
            console.error(e);
        }
    }

    // ğŸ”´ æ˜¾å¼å®šä¹‰çš„é¢œè‰²é€»è¾‘ (æœ€ç¨³å¦¥ï¼Œé˜²æ­¢ Tailwind ä¸¢å¤±æ ·å¼)
    function createCardHtml(tool) {
        let colorClass = 'text-blue-600';
        let hoverClass = 'hover:border-blue-300';
        let badgeBg = 'bg-blue-50';
        let badgeText = 'AI';

        if (tool.collection === 'mac') {
            colorClass = 'text-purple-600';
            hoverClass = 'hover:border-purple-300';
            badgeBg = 'bg-purple-50';
            badgeText = 'Mac';
        } else if (tool.collection === 'selfhosted') {
            colorClass = 'text-orange-600';
            hoverClass = 'hover:border-orange-300';
            badgeBg = 'bg-orange-50';
            badgeText = 'Self-Hosted';
        } else if (tool.collection === 'windows') {
            // ğŸ”´ Windows æ ·å¼
            colorClass = 'text-sky-600';
            hoverClass = 'hover:border-sky-300';
            badgeBg = 'bg-sky-50';
            badgeText = 'Windows';
        }

        const slug = tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        
        return `<a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md ${hoverClass} transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:${colorClass}">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 ${badgeBg} ${colorClass} rounded">${badgeText}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2">
                <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span>
            </div>
        </a>`;
    }

    searchInput.addEventListener('focus', loadAllData);
    loadMoreBtn.addEventListener('mouseenter', loadAllData);

    loadMoreBtn.addEventListener('click', async () => {
        await loadAllData();
        let targetData = allAiData;
        if(currentTab === 'mac') targetData = allMacData;
        if(currentTab === 'selfhosted') targetData = allSelfData;
        if(currentTab === 'windows') targetData = allWinData; // ğŸ”´

        const targetGrid = document.getElementById(`grid-${currentTab}`);
        const currentCount = targetGrid.children.length;
        
        if (currentCount < targetData.length) {
            const remaining = targetData.slice(currentCount);
            targetGrid.insertAdjacentHTML('beforeend', remaining.map(createCardHtml).join(''));
        }
        loadMoreBtn.classList.add('hidden');
    });

    searchInput.addEventListener('input', async (e) => {
        const term = e.target.value.toLowerCase();
        if (!isDataLoaded && term.length > 0) await loadAllData();

        if (term.length > 0) {
            loadMoreBtn.classList.add('hidden');
            ['ai', 'mac', 'selfhosted', 'windows'].forEach(t => document.getElementById(`grid-${t}`).classList.remove('hidden'));

            const render = (data, id) => {
                const m = data.filter(t => t.name.toLowerCase().includes(term));
                document.getElementById(id).innerHTML = m.map(createCardHtml).join('');
                return m.length;
            };

            const total = render(allAiData,'grid-ai') + render(allMacData,'grid-mac') + render(allSelfData,'grid-selfhosted') + render(allWinData,'grid-windows');
            if (total === 0) noResults.classList.remove('hidden'); else noResults.classList.add('hidden');
        } else {
            window.location.reload();
        }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(t => t.className = 'tab-btn px-5 py-2 rounded-lg font-bold text-sm transition text-slate-500 hover:text-slate-700');
            
            const target = btn.dataset.target;
            let activeColor = 'text-blue-600';
            if (target === 'mac') activeColor = 'text-purple-600';
            if (target === 'selfhosted') activeColor = 'text-orange-600';
            if (target === 'windows') activeColor = 'text-sky-600'; // ğŸ”´
            
            btn.className = `tab-btn active px-5 py-2 rounded-lg font-bold text-sm transition bg-white ${activeColor} shadow-sm`;
            currentTab = target;
            
            document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
            
            document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`cat-${currentTab}`).classList.remove('hidden');
            
            loadMoreBtn.classList.remove('hidden');
        });
    });
  </script>
</Layout>