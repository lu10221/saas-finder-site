---
import Layout from '../layouts/Layout.astro';
import aiData from '../data/ai_tools.json';
import macData from '../data/mac_tools.json';

// å‡†å¤‡æ•°æ®
const aiTools = aiData.map(t => ({ ...t, collection: 'ai' }));
const safeMacData = macData || [];
const macTools = safeMacData.map(t => ({ ...t, collection: 'mac' }));

// æå–æ‰€æœ‰åˆ†ç±»
const allTools = [...aiTools, ...macTools];
const aiCategories = [...new Set(aiTools.map(t => t.category).filter(Boolean))].sort();
const macCategories = [...new Set(macTools.map(t => t.category).filter(Boolean))].sort();

// ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šé¦–å±åªæ¸²æŸ“å‰ 36 ä¸ªå·¥å…·ï¼Œå‰©ä¸‹çš„äº¤ç»™ JS å¤„ç†
const INITIAL_COUNT = 36;
const initialAiTools = aiTools.slice(0, INITIAL_COUNT);
const initialMacTools = macTools.slice(0, INITIAL_COUNT);
---

<Layout title="ToolStock - Best AI & Mac Tools Directory" description="Discover the best AI tools and Mac software alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated database of <span class="font-bold">{aiTools.length}</span> AI tools and <span class="font-bold">{macTools.length}</span> Mac apps.
    </p>

    <div class="flex justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-full w-fit mx-auto">
      <button class="tab-btn active px-8 py-2.5 rounded-full font-bold text-sm transition-all duration-200 bg-white text-blue-600 shadow-sm ring-1 ring-slate-200" data-target="ai">
        ğŸ¤– AI Tools
      </button>
      <button class="tab-btn px-8 py-2.5 rounded-full font-bold text-sm transition-all duration-200 text-slate-500 hover:text-slate-700" data-target="mac">
        ğŸ Mac Apps
      </button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search specific tool..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto animate-fade-in">
      {aiCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>
      ))}
    </div>

    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto animate-fade-in">
      {macCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>
      ))}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
    {/* åªæ¸²æŸ“å‰ 36 ä¸ªï¼Œå…¶ä»–çš„ç”± JS åŠ¨æ€åŠ è½½ */}
    {initialAiTools.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-')}`} 
         class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
           {tool.category && <span class="text-xs px-2 py-1 border border-slate-200 rounded text-slate-500">{tool.category}</span>}
        </div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
    {initialMacTools.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-')}`} 
         class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
           {tool.category && <span class="text-xs px-2 py-1 border border-slate-200 rounded text-slate-500">{tool.category}</span>}
        </div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">
      Load More Tools
    </button>
  </div>

  <div id="no-results" class="hidden text-center py-12">
    <p class="text-lg text-slate-500">No tools found matching your search.</p>
  </div>

  <script is:inline define:vars={{ aiTools, macTools }}>
    // å°†æœåŠ¡å™¨ç«¯æ•°æ®ä¼ ç»™æµè§ˆå™¨å†…å­˜
    const allAiData = aiTools;
    const allMacData = macTools;
    let currentTab = 'ai';
    let isSearching = false;

    // è·å– DOM å…ƒç´ 
    const gridAi = document.getElementById('grid-ai');
    const gridMac = document.getElementById('grid-mac');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const noResults = document.getElementById('no-results');
    const tabs = document.querySelectorAll('.tab-btn');
    const catContainers = document.querySelectorAll('.cat-container');

    // ç”Ÿæˆå¡ç‰‡ HTML çš„å‡½æ•° (JS æ¸²æŸ“ç”¨)
    function createCardHtml(tool) {
        const isMac = tool.collection === 'mac';
        const colorClass = isMac ? 'text-purple-600' : 'text-blue-600';
        const hoverClass = isMac ? 'hover:border-purple-300' : 'hover:border-blue-300';
        const badgeBg = isMac ? 'bg-purple-50' : 'bg-blue-50';
        const slug = tool.slug || tool.name.toLowerCase().replace(/\s+/g, '-');
        
        return `
        <a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md ${hoverClass} transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:${colorClass}">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 ${badgeBg} ${colorClass} rounded">${isMac ? 'Mac' : 'AI'}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2">
                <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span>
                ${tool.category ? `<span class="text-xs px-2 py-1 border border-slate-200 rounded text-slate-500">${tool.category}</span>` : ''}
            </div>
        </a>
        `;
    }

    // "åŠ è½½æ›´å¤š" é€»è¾‘ï¼šæŠŠå‰©ä¸‹çš„æ•°æ®ä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ (ä¸ºäº†ç®€å•ï¼Œæš‚ä¸åšæ— é™æ»šåŠ¨)
    // å®é™…é¡¹ç›®ä¸­å¯ä»¥æ¯æ¬¡åŠ  30 ä¸ªï¼Œè¿™é‡Œä¸ºäº†æœç´¢æ–¹ä¾¿ï¼Œç‚¹å‡»ååŠ è½½å½“å‰ Tab çš„å…¨éƒ¨
    loadMoreBtn.addEventListener('click', () => {
        const targetData = currentTab === 'ai' ? allAiData : allMacData;
        const targetGrid = currentTab === 'ai' ? gridAi : gridMac;
        
        // ä»ç¬¬ 36 ä¸ªå¼€å§‹æ¸²æŸ“
        const remaining = targetData.slice(36);
        const html = remaining.map(createCardHtml).join('');
        targetGrid.insertAdjacentHTML('beforeend', html);
        
        loadMoreBtn.classList.add('hidden'); // åŠ è½½å®Œå°±éšè—æŒ‰é’®
    });

    // Tab åˆ‡æ¢é€»è¾‘
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(t => {
            t.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'ring-1', 'ring-slate-200');
            t.classList.add('text-slate-500');
        });
        btn.classList.remove('text-slate-500');
        btn.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'ring-1', 'ring-slate-200');

        currentTab = btn.dataset.target;
        
        // åˆ‡æ¢ Grid å’Œ åˆ†ç±»
        document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
        document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
        
        document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
        document.getElementById(`cat-${currentTab}`).classList.remove('hidden');

        // åˆ‡æ¢ Tab æ—¶é‡ç½®â€œåŠ è½½æ›´å¤šâ€æŒ‰é’®çŠ¶æ€
        // å¦‚æœå½“å‰ Tab è¿˜æ²¡åŠ è½½å®Œï¼Œå°±æ˜¾ç¤ºæŒ‰é’®
        const targetData = currentTab === 'ai' ? allAiData : allMacData;
        const currentCount = document.getElementById(`grid-${currentTab}`).children.length;
        if (currentCount < targetData.length && !isSearching) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
      });
    });

    // æœç´¢é€»è¾‘ (æé€Ÿç‰ˆ - ç›´æ¥æ“ä½œå†…å­˜æ•°æ®)
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        isSearching = term.length > 0;

        if (isSearching) {
            loadMoreBtn.classList.add('hidden'); // æœç´¢æ—¶ä¸æ˜¾ç¤ºåŠ è½½æ›´å¤š
            
            // æœç´¢å…¨éƒ¨æ•°æ® (AI + Mac)
            const aiMatches = allAiData.filter(t => t.name.toLowerCase().includes(term) || (t.tagline && t.tagline.toLowerCase().includes(term)));
            const macMatches = allMacData.filter(t => t.name.toLowerCase().includes(term) || (t.tagline && t.tagline.toLowerCase().includes(term)));

            // é‡æ–°æ¸²æŸ“ AI Grid
            gridAi.innerHTML = aiMatches.map(createCardHtml).join('');
            gridAi.classList.remove('hidden'); // æœç´¢æ—¶å¼ºåˆ¶æ˜¾ç¤ºï¼Œæ–¹ä¾¿è·¨ç±»åˆ«æŸ¥æ‰¾
            
            // é‡æ–°æ¸²æŸ“ Mac Grid
            gridMac.innerHTML = macMatches.map(createCardHtml).join('');
            gridMac.classList.remove('hidden');

            // ç»“æœåˆ¤æ–­
            if (aiMatches.length === 0 && macMatches.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }
        } else {
            // æ¸…ç©ºæœç´¢æ—¶ï¼Œæ¢å¤é¡µé¢åˆå§‹çŠ¶æ€
            // ç®€å•å¤„ç†ï¼šé‡æ–°åŠ è½½é¡µé¢ï¼Œæˆ–è€…å¤æ‚çš„ DOM æ¢å¤ã€‚
            // ä¸ºäº†ä½“éªŒæµç•…ï¼Œå»ºè®®ç®€å• reload æˆ–è€…ä¿ç•™å½“å‰çš„æ¸²æŸ“çŠ¶æ€ï¼ˆä½†ä¸å®Œç¾ï¼‰ã€‚
            // æœ€ç®€å•çš„æ–¹æ¡ˆï¼šç›´æ¥åˆ·æ–°é¡µé¢æ¢å¤çŠ¶æ€
            window.location.reload();
        }
    });
  </script>
</Layout>