---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// ËæÖÂä©ÂáΩÊï∞ÔºöÂÆâÂÖ®ËØªÂèñÊï∞ÊçÆ (È¶ñÂ±èÁõ¥Âá∫Ââç 36 ‰∏™)
function getInitialData(filename) {
  try {
    // ‰ºòÂÖàÊâæ public/data (ÊûÑÂª∫ÁéØÂ¢É), ÂÖ∂Ê¨°Êâæ src/data (ÂºÄÂèëÁéØÂ¢É)
    let filePath = path.join(process.cwd(), 'public', 'data', filename);
    if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);

    if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf-8');
        const data = JSON.parse(content);
        // Ê†πÊçÆÊñá‰ª∂ÂêçÊâìÊ†á
        let type = 'ai';
        if (filename.includes('mac')) type = 'mac';
        if (filename.includes('selfhosted')) type = 'selfhosted';
        
        return data.slice(0, 36).map(t => ({ ...t, collection: type }));
    }
    return [];
  } catch (e) { return []; }
}

// ËæÖÂä©ÂáΩÊï∞ÔºöÊèêÂèñÂàÜÁ±ª
function getCategories(filename) {
    try {
        let filePath = path.join(process.cwd(), 'public', 'data', filename);
        if (!fs.existsSync(filePath)) filePath = path.join(process.cwd(), 'src', 'data', filename);
        
        if (fs.existsSync(filePath)) {
            const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
            return [...new Set(data.map(t => t.category).filter(Boolean))].sort();
        }
        return [];
    } catch (e) { return []; }
}

// 1. ËØªÂèñÊï∞ÊçÆ
const initialAi = getInitialData('ai_tools.json');
const initialMac = getInitialData('mac_tools.json');
const initialSelfHosted = getInitialData('selfhosted_tools.json'); // üî¥ Êñ∞Â¢û

// 2. ËØªÂèñÂàÜÁ±ª
const aiCategories = getCategories('ai_tools.json');
const macCategories = getCategories('mac_tools.json');
const selfHostedCategories = getCategories('selfhosted_tools.json'); // üî¥ Êñ∞Â¢û
---

<Layout title="ToolStock - AI, Mac & Self-Hosted Tools Directory" description="Discover the best AI tools, Mac apps, and Self-Hosted software alternatives.">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-extrabold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-600 to-orange-500">
      Find the Perfect Tool
    </h1>
    <p class="text-xl text-slate-600 mb-8">
      Curated directory of best software alternatives.
    </p>

    <div class="flex flex-wrap justify-center gap-2 mb-8 bg-slate-100 p-1 rounded-xl w-fit mx-auto">
      <button class="tab-btn active px-6 py-2 rounded-lg font-bold text-sm transition-all duration-200 bg-white text-blue-600 shadow-sm ring-1 ring-slate-200" data-target="ai">
        ü§ñ AI Tools
      </button>
      <button class="tab-btn px-6 py-2 rounded-lg font-bold text-sm transition-all duration-200 text-slate-500 hover:text-slate-700" data-target="mac">
        üçé Mac Apps
      </button>
      <button class="tab-btn px-6 py-2 rounded-lg font-bold text-sm transition-all duration-200 text-slate-500 hover:text-slate-700" data-target="selfhosted">
        üê≥ Self-Hosted
      </button>
    </div>
    
    <div class="max-w-xl mx-auto mb-8 relative">
      <input type="text" id="search-input" placeholder="Search for tools..." class="w-full px-6 py-4 pl-12 rounded-full border border-slate-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-lg transition" />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>

    <div id="cat-ai" class="cat-container flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {aiCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-blue-600 hover:border-blue-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-mac" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {macCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-purple-600 hover:border-purple-300 transition">{cat}</a>
      ))}
    </div>
    <div id="cat-selfhosted" class="cat-container hidden flex flex-wrap justify-center gap-2 mb-12 max-w-4xl mx-auto">
      {selfHostedCategories.map((cat) => (
        <a href={`/category/${cat.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-500 hover:text-orange-600 hover:border-orange-300 transition">{cat}</a>
      ))}
    </div>
  </div>

  <div id="grid-ai" class="tool-grid grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialAi.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} 
         class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-blue-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-blue-50 text-blue-600 rounded">AI</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
        </div>
      </a>
    ))}
  </div>

  <div id="grid-mac" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialMac.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} 
         class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-purple-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-purple-50 text-purple-600 rounded">Mac</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
        </div>
      </a>
    ))}
  </div>

  <div id="grid-selfhosted" class="tool-grid hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialSelfHosted.map((tool) => (
      <a href={`/tool/${tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '')}`} 
         class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-orange-300 transition">
        <div class="flex justify-between items-start mb-3">
            <h2 class="text-xl font-bold text-slate-900 group-hover:text-orange-600">{tool.name}</h2>
            <span class="text-[10px] uppercase font-bold px-2 py-1 bg-orange-50 text-orange-600 rounded">Self-Hosted</span>
        </div>
        <p class="text-sm text-slate-500 mb-4 line-clamp-2">{tool.tagline}</p>
        <div class="flex flex-wrap gap-2">
           <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">{tool.pricing_type}</span>
        </div>
      </a>
    ))}
  </div>

  <div class="text-center mt-12">
    <button id="load-more-btn" class="px-8 py-3 bg-white border border-slate-300 rounded-full font-semibold text-slate-600 hover:bg-slate-50 transition shadow-sm">Load More Tools</button>
  </div>
  <div id="no-results" class="hidden text-center py-12"><p class="text-lg text-slate-500">No tools found matching your search.</p></div>

  <script is:inline>
    let allAiData = [];
    let allMacData = [];
    let allSelfHostedData = []; // üî¥ Êñ∞Â¢û
    let isDataLoaded = false;
    let currentTab = 'ai';

    const loadMoreBtn = document.getElementById('load-more-btn');
    const searchInput = document.getElementById('search-input');
    const noResults = document.getElementById('no-results');

    async function loadAllData() {
        if (isDataLoaded) return;
        loadMoreBtn.textContent = "Loading...";
        try {
            // üî¥ Â¢ûÂä† selfhosted ÁöÑ fetch
            const [resAi, resMac, resSelf] = await Promise.all([
                fetch('/data/ai_tools.json'),
                fetch('/data/mac_tools.json'),
                fetch('/data/selfhosted_tools.json')
            ]);
            
            const rawAi = await resAi.json();
            const rawMac = await resMac.json();
            const rawSelf = await resSelf.json();
            
            allAiData = rawAi.map(t => ({...t, collection: 'ai'}));
            allMacData = rawMac.map(t => ({...t, collection: 'mac'}));
            allSelfHostedData = rawSelf.map(t => ({...t, collection: 'selfhosted'}));
            
            isDataLoaded = true;
            loadMoreBtn.textContent = "Load More Tools";
        } catch (e) {
            loadMoreBtn.textContent = "Error Loading";
            console.error(e);
        }
    }

    function createCardHtml(tool) {
        // üî¥ È¢úËâ≤ÈÄªËæëÂçáÁ∫ß
        let colorClass = 'text-blue-600';
        let hoverClass = 'hover:border-blue-300';
        let badgeBg = 'bg-blue-50';
        let badgeText = 'AI';

        if (tool.collection === 'mac') {
            colorClass = 'text-purple-600';
            hoverClass = 'hover:border-purple-300';
            badgeBg = 'bg-purple-50';
            badgeText = 'Mac';
        } else if (tool.collection === 'selfhosted') {
            colorClass = 'text-orange-600';
            hoverClass = 'hover:border-orange-300';
            badgeBg = 'bg-orange-50';
            badgeText = 'Self-Hosted';
        }

        const slug = tool.slug || tool.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        
        return `<a href="/tool/${slug}" class="tool-card group block bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md ${hoverClass} transition">
            <div class="flex justify-between items-start mb-3">
                <h2 class="text-xl font-bold text-slate-900 group-hover:${colorClass}">${tool.name}</h2>
                <span class="text-[10px] uppercase font-bold px-2 py-1 ${badgeBg} ${colorClass} rounded">${badgeText}</span>
            </div>
            <p class="text-sm text-slate-500 mb-4 line-clamp-2">${tool.tagline || ''}</p>
            <div class="flex flex-wrap gap-2">
                <span class="text-xs px-2 py-1 bg-slate-100 rounded text-slate-600">${tool.pricing_type}</span>
            </div>
        </a>`;
    }

    searchInput.addEventListener('focus', loadAllData);
    loadMoreBtn.addEventListener('mouseenter', loadAllData);

    loadMoreBtn.addEventListener('click', async () => {
        await loadAllData();
        
        let targetData = allAiData;
        if(currentTab === 'mac') targetData = allMacData;
        if(currentTab === 'selfhosted') targetData = allSelfHostedData; // üî¥

        const targetGrid = document.getElementById(`grid-${currentTab}`);
        const currentCount = targetGrid.children.length;
        
        if (currentCount < targetData.length) {
            const remaining = targetData.slice(currentCount);
            targetGrid.insertAdjacentHTML('beforeend', remaining.map(createCardHtml).join(''));
        }
        loadMoreBtn.classList.add('hidden');
    });

    // ÊêúÁ¥¢ÈÄªËæë
    searchInput.addEventListener('input', async (e) => {
        const term = e.target.value.toLowerCase();
        if (!isDataLoaded && term.length > 0) await loadAllData();

        if (term.length > 0) {
            loadMoreBtn.classList.add('hidden');
            
            // ÊòæÁ§∫ÊâÄÊúâ Grid
            ['ai', 'mac', 'selfhosted'].forEach(type => {
                document.getElementById(`grid-${type}`).classList.remove('hidden');
            });

            const filterAndRender = (data, elementId) => {
                const matches = data.filter(t => t.name.toLowerCase().includes(term));
                document.getElementById(elementId).innerHTML = matches.map(createCardHtml).join('');
                return matches.length;
            };

            const countAi = filterAndRender(allAiData, 'grid-ai');
            const countMac = filterAndRender(allMacData, 'grid-mac');
            const countSelf = filterAndRender(allSelfHostedData, 'grid-selfhosted');

            if (countAi + countMac + countSelf === 0) noResults.classList.remove('hidden');
            else noResults.classList.add('hidden');
        } else {
            window.location.reload();
        }
    });

    // Tab ÂàáÊç¢ÈÄªËæë
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆÊ†∑Âºè
            document.querySelectorAll('.tab-btn').forEach(t => {
                t.className = 'tab-btn px-6 py-2 rounded-lg font-bold text-sm transition-all duration-200 text-slate-500 hover:text-slate-700';
            });
            // ÊøÄÊ¥ªÂΩìÂâçÊåâÈíÆ (Ê†πÊçÆ‰∏çÂêå Tab Áªô‰∏çÂêåÈ¢úËâ≤)
            const target = btn.dataset.target;
            let activeColor = 'text-blue-600';
            if (target === 'mac') activeColor = 'text-purple-600';
            if (target === 'selfhosted') activeColor = 'text-orange-600';
            
            btn.className = `tab-btn active px-6 py-2 rounded-lg font-bold text-sm transition-all duration-200 bg-white ${activeColor} shadow-sm ring-1 ring-slate-200`;

            currentTab = target;
            
            // ÂàáÊç¢ Grid Âíå ÂàÜÁ±ª
            document.querySelectorAll('.tool-grid').forEach(g => g.classList.add('hidden'));
            document.getElementById(`grid-${currentTab}`).classList.remove('hidden');
            
            document.querySelectorAll('.cat-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(`cat-${currentTab}`).classList.remove('hidden');
            
            loadMoreBtn.classList.remove('hidden');
        });
    });
  </script>
</Layout>