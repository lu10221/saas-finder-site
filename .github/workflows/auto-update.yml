name: Auto Loop Update

on:
  workflow_dispatch: {} # å…è®¸æ‰‹åŠ¨ç‚¹å‡»å¯åŠ¨

permissions:
  contents: write
  actions: write # ğŸ”´ å…³é”®æƒé™ï¼šå…è®¸è§¦å‘ä¸‹ä¸€ä¸ª Workflow

jobs:
  run-scrapers:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡æ­»

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ğŸ”´ å…³é”®ï¼šä½¿ç”¨ PAT (Personal Access Token) æ£€å‡º
          # è¿™æ ·æäº¤çš„ä»£ç æ‰èƒ½è§¦å‘åç»­äº‹ä»¶ï¼Œæˆ–è€…ä½ æœ‰å…¶ä»– Workflow ä¾èµ–å®ƒ
          token: ${{ secrets.GH_PAT }} 

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm install openai

      # 2. è¿è¡Œæ‰€æœ‰è„šæœ¬
      - name: Run All Scripts
        env:
          VOLC_API_KEY: ${{ secrets.VOLC_API_KEY }}
          ENDPOINT_ID: ${{ secrets.ENDPOINT_ID }}
        run: |
          echo "ğŸš€ Starting Mac Script (Batch Limit: 200)..."
          node mac-script.js
          
          echo "ğŸš€ Starting Self-Hosted Script (Batch Limit: 200)..."
          node selfhosted-script.js

      # 3. æäº¤ä»£ç å¹¶è®¾ç½®çŠ¶æ€å˜é‡
      - name: Check and Commit
        id: check_changes # ğŸ”´ ç»™è¿™ä¸€æ­¥èµ·ä¸ªIDï¼Œæ–¹ä¾¿ä¸‹ä¸€æ­¥è¯»å–å®ƒçš„ç»“æœ
        run: |
          git config --global user.name "Loop Bot"
          git config --global user.email "bot@toolstock.net"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ–‡ä»¶å‘ç”Ÿå˜åŒ–
          if [[ -n $(git status -s) ]]; then
            # è®¾ç½®è¾“å‡ºå˜é‡ä¸º true
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ‰ å‘ç°æ–°æ•°æ®ï¼Œæ­£åœ¨æäº¤..."
            
            git add .
            git commit -m "ğŸ¤– Batch update: Added new tools"
            
            # è§£å†³å†²çªï¼šå…ˆæ‹‰åæ¨
            git pull --rebase --autostash origin main
            
            git push
            echo "âœ… æˆåŠŸæ¨é€ï¼"
          else
            # è®¾ç½®è¾“å‡ºå˜é‡ä¸º false
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ’¤ æ²¡æœ‰æ–°æ•°æ®ç”Ÿæˆ (ä»»åŠ¡å¯èƒ½å·²å…¨éƒ¨å®Œæˆ)ã€‚"
          fi

      # 4. æ ¸å¿ƒå¾ªç¯é€»è¾‘ï¼šåªæœ‰åœ¨â€œåˆšæ‰æœ‰æ›´æ–°â€æ—¶æ‰æ‰§è¡Œ
      - name: Wait and Trigger Next Loop
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # å¿…é¡»ä½¿ç”¨ PAT æ‰æœ‰æƒé™è§¦å‘
        run: |
          echo "â³ æœ¬æ‰¹æ¬¡å®Œæˆã€‚æ­£åœ¨å†·å´ 30 åˆ†é’Ÿä»¥é¿å¼€é™åˆ¶..."
          sleep 1800  # æš‚åœ 1800 ç§’ (30åˆ†é’Ÿ)
          
          echo "ğŸ”„ å†·å´ç»“æŸï¼Œè§¦å‘ä¸‹ä¸€è½®å¾ªç¯..."
          # é‡æ–°è¿è¡Œå½“å‰è¿™ä¸ª Workflowæ–‡ä»¶ (manual-update.yml)
          gh workflow run "${{ github.workflow }}" --ref main