name: Auto Loop Update

on:
  workflow_dispatch: {} # 允许手动点击启动

permissions:
  contents: write
  actions: write # 🔴 关键权限：允许触发下一个 Workflow

jobs:
  run-scrapers:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 设置超时防止卡死

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 🔴 关键：使用 PAT (Personal Access Token) 检出
          # 这样提交的代码才能触发后续事件，或者你有其他 Workflow 依赖它
          token: ${{ secrets.GH_PAT }} 

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm install openai

      # 2. 运行所有脚本 (新增了 Windows)
      - name: Run All Scripts
        env:
          VOLC_API_KEY: ${{ secrets.VOLC_API_KEY }}
          ENDPOINT_ID: ${{ secrets.ENDPOINT_ID }}
        run: |
          # echo "🚀 Starting Mac Script (Batch Limit: 200)..."
          # node mac-script.js
          
          # echo "🚀 Starting Self-Hosted Script (Batch Limit: 200)..."
          # node selfhosted-script.js

          # echo "🚀 Starting Windows Script (Batch Limit: 200)..."
          # node windows-script.js
          
          echo "🚀 Starting Public APIs Script (Batch Limit: 200)..."
          node publicapis-script.js

      # 3. 提交代码并设置状态变量
      - name: Check and Commit
        id: check_changes # 🔴 给这一步起个ID，方便下一步读取它的结果
        run: |
          git config --global user.name "Loop Bot"
          git config --global user.email "bot@toolstock.net"
          
          # 检查是否有任何文件发生变化
          if [[ -n $(git status -s) ]]; then
            # 设置输出变量为 true
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "🎉 发现新数据，正在提交..."
            
            git add .
            git commit -m "🤖 Batch update: Added new tools (Mac/SelfHosted/Windows)"
            
            # 解决冲突：先拉后推
            git pull --rebase --autostash origin main
            
            git push
            echo "✅ 成功推送！"
          else
            # 设置输出变量为 false
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "💤 没有新数据生成 (任务可能已全部完成)。"
          fi

      # 4. 核心循环逻辑：只有在“刚才有更新”时才执行
      - name: Wait and Trigger Next Loop
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }} # 必须使用 PAT 才有权限触发
        run: |
          echo "⏳ 本批次完成。正在冷却 30 分钟以避开限制..."
          sleep 1800  # 暂停 1800 秒 (30分钟)
          
          echo "🔄 冷却结束，触发下一轮循环..."
          # 重新运行当前这个 Workflow文件
          gh workflow run "${{ github.workflow }}" --ref main